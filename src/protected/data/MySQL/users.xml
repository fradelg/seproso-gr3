<?xml version="1.0" encoding="utf-8" ?>
<sqlMap>

<resultMap id="seproso-user" class="SeprosoUser" GroupBy="Name">
	<result property="Name" column="Name" />
	<result property="Project" column="Project" />
	<result property="EmailAddress" column="EmailAddress" />
	<result property="Roles" Type="array" resultMapping="user-roles-result" />
</resultMap>

<resultMap id="user-roles-result"><result column="role" /></resultMap>

<!--
<select id="GetUserByName" parameterClass="string" resultMap="seproso-user">
	SELECT 
		usuario.nick as Name,
		usuario.email as EmailAddress,
		rol.tipo as role
	FROM
		usuario
	WHERE
		nick = #value#
</select>
-->

<select id="UsernameExists" parameterClass="string" resultClass="boolean">
	SELECT COUNT(nick) FROM usuario WHERE nick = #value#
</select>

<select id="GetProject" parameterClass="string" resultClass="string">
	SELECT proyecto.titulo
	FROM usuario, trabajador, proyecto 
	WHERE usuario.nick = #value# 
		AND trabajador.idUsuario = usuario.idUsuario
		AND proyecto.idProyecto = trabajador.idProyecto
</select>

<select id="GetUserByName" parameterClass="string" resultMap="seproso-user">
	SELECT 
		usuario.nick as Name,
		usuario.email as EmailAddress,
		usuario.tipo as role
	FROM
		usuario
	WHERE
		nick = #value#
</select>
    
<select id="GetAllUsers" resultMap="seproso-user">
	SELECT
		usuario.nick as Name,
		usuario.email as EmailAddress,
		usuario.tipo as role
	FROM
		usuario
</select>

<select id="ValidateUser" parameterClass="array" resultClass="boolean">
	SELECT 
		COUNT(nick)
	FROM
		usuario
	WHERE
		nick = #username# AND password = #password#
</select>

<select id="GetAllRoles" resultClass="string">
	SELECT rol.tipo FROM rol
</select>

<insert id="AddNewUser" parameterClass="array">
	INSERT INTO 
		usuario (nick, password, email)
	VALUES
		(#user.Name#, #password#, #user.EMailAddress#)
</insert>

<update id="DeleteUserByName">
	UPDATE usuario SET Disabled = 1  WHERE nick = #value#
</update>

<insert id="RegisterAutoSignon" parameterClass="array">
	INSERT INTO 
		signon (SessionToken, nick, LastSignOnDate)
	VALUES
		(#token#, #nick#, NOW())
</insert>

<select id="ValidateAutoSignon" resultMap="seproso-user">
	SELECT
		usuario.nick as Name,
		usuario.Project as Project,
		usuario.email as EmailAddress,
		rol.tipo as role
	FROM
		usuario LEFT JOIN rol ON usuario.nick = rol.UserID,
		signon
	WHERE
		usuario.nick = signon.nick
		AND signon.SessionToken = #value#
</select>

<update id="UpdateSignon">
	UPDATE signon SET LastSignOnDate = NOW() 
	WHERE SessionToken = #value#
</update>

<update id="UpdateUserDetails" parameterClass="SeprosoUser">
	UPDATE usuario 
	SET email = #email#
	WHERE nick = #Name#
</update>

<update id="UpdateUserProject" parameterClass="SeprosoUser">
	UPDATE usuario 
	SET Project = #Project#
	WHERE nick = #Name#
</update>

<update id="UpdateUserDetailsAndPassword" parameterClass="array">
	UPDATE usuario 
	SET email = #user.email#, password = #password#
	WHERE nick = #user.Name#
</update>

<delete id="DeleteAutoSignon">
	DELETE FROM signon WHERE nick = #value#
</delete>

<delete id="DeleteAllSignon">
	DELETE FROM signon
</delete>

</sqlMap>
