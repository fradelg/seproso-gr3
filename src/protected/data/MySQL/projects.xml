<?xml version="1.0" encoding="utf-8" ?>
<sqlMap>

<resultMap id="project-result" class="ProjectRecord">
	<result property="ID" column="ProjectID" type="integer"/>
	<result property="ProcessID" column="ProcessID" type="integer"/>
	<result property="ManagerID" column="ManagerID" type="integer"/>
	<result property="Title" column="Title" />
	<result property="Description" column="Description" />
	<result property="Date" column="Date" typeHandler="DateTimeTypeHandler" />
	<result property="Burchet" column="Burchet" type="float" />
	<result property="Active" column="Active" />
</resultMap>

<select id="ProjectNameExists" resultClass="boolean">
	SELECT COUNT(titulo) FROM proyecto WHERE titulo = #value#
</select>

<select id="GetProjectID" parameterClass="string" resultClass="integer">
	SELECT proyecto.idProyecto FROM proyecto WHERE titulo = #value#
</select>

<insert id="CreateNewProject" parameterClass="ProjectRecord">
	INSERT INTO proyecto
	(Modelo_idModelo, titulo, descripcion, fecha, presupuesto, activo)
	VALUES
	(#Name#, #Description#, NOW(), #EstimateDuration#,
		#CompletionDate, typeHandler=DateTimeTypeHandler#, 
		#CreatorUserName#, #ManagerUserName#)
	<selectKey property="ID" type="post" resultClass="int">
		select LAST_INSERT_ID() as value
    </selectKey>
</insert>

<select id="GetProjectByID" parameterClass="integer" resultMap="project-result">
	SELECT 
		proyecto.idModelo as ProcessID,
		proyecto.idJefe as ManagerID,
		proyecto.titulo as Title,
		proyecto.descripcion Description,
		proyecto.fecha as Date,
		proyecto.presupuesto as Burchet,
		proyecto.activo as Active
	FROM proyecto
	WHERE 
		proyecto.idProyecto = #value# 
	GROUP BY
		proyecto.idProyecto
	ORDER BY
		proyecto.titulo
</select>

<select id="GetProjectByWorker" parameterClass="integer" resultMap="project-result">
	SELECT 
		proyecto.idModelo as ProcessID,
		proyecto.idJefe as ManagerID,
		proyecto.titulo as Title,
		proyecto.descripcion Description,
		proyecto.fecha as Date,
		proyecto.presupuesto as Burchet,
		proyecto.activo as Active
	FROM proyecto, participacion
	WHERE 
		participacion.idUsuario = #value# 
		AND proyecto.idProyecto = participacion.idProyecto 
	ORDER BY
		proyecto.titulo
</select>

<select id="GetProjectsByWorker" parameterClass="integer" resultClass="string">
	SELECT 
		proyecto.titulo
	FROM 
		proyecto, participacion
	WHERE 
		participacion.idUsuario = #value# 
		AND proyecto.idProyecto = participacion.idProyecto 
	ORDER BY
		proyecto.titulo
</select>

<select id="GetAllProjects" resultMap="project-result">
	SELECT 
		proyecto.idModelo as ProcessID,
		proyecto.idJefe as ManagerID,
		proyecto.titulo as Title,
		proyecto.descripcion Description,
		proyecto.fecha as Date,
		proyecto.presupuesto as Burchet,
		proyecto.activo as Active
	FROM proyecto
</select>

<select id="GetAllProjectsOrdered" resultMap="project-result" extends="GetAllProjects">
	ORDER BY $sort$ $order$
</select>

<select id="GetProjectsByManagerName" resultMap="project-result">
	SELECT 
		proyecto.ProjectID as ProjectID,
		proyecto.titulo as Name,
		proyecto.Description as Description,
		proyecto.CreationDate as CreationDate,
		proyecto.EstimateDuration as EstimateDuration,
		proyecto.CompletionDate as CompletionDate,
		proyecto.CreatorID as CreatorID,
		proyecto.ManagerID as ManagerID,
		SUM(time_entry.Duration) as ActualDuration
	FROM proyecto
		LEFT JOIN categories ON proyecto.ProjectID = categories.ProjectID
		LEFT JOIN time_entry ON categories.CategoryID = time_entry.CategoryID
	WHERE 
			Disabled = 0 
		AND proyecto.ManagerID = #value#
	GROUP BY
		proyecto.ProjectID
	ORDER BY
		proyecto.titulo
</select>

<select id="GetProjectsByUserName" resultMap="project-result">
	SELECT 
		proyecto.ProjectID as ProjectID,
		proyecto.titulo as Name,
		proyecto.Description as Description,
		proyecto.CreationDate as CreationDate,
		proyecto.EstimateDuration as EstimateDuration,
		proyecto.CompletionDate as CompletionDate,
		proyecto.CreatorID as CreatorID,
		proyecto.ManagerID as ManagerID,
		SUM(time_entry.Duration) as ActualDuration
	FROM proyecto
		LEFT JOIN categories ON proyecto.ProjectID = categories.ProjectID
		LEFT JOIN time_entry ON categories.CategoryID = time_entry.CategoryID,
		proyecto_members
	WHERE 
			proyecto_members.ProjectID = proyecto.ProjectID
		AND proyecto_members.UserID = #value#
		AND proyecto.Disabled = 0
	GROUP BY
		proyecto.ProjectID
	ORDER BY
		proyecto.titulo
</select>

<update id="DeleteProject" parameterClass="integer">
	UPDATE proyecto SET Disabled = 1 WHERE ProjectID = #value#
</update>

<select id="GetProjectMembers" parameterClass="integer">
	SELECT UserID FROM proyecto_members WHERE ProjectID = #value#
</select>

<insert id="AddUserToProject" parameterClass="array">
	INSERT INTO proyecto_members (UserID, ProjectID)
	VALUES(#username#, #proyecto#)
</insert>

<delete id="RemoveUserFromProject" parameterClass="array">
	DELETE FROM proyecto_members WHERE ProjectID = #project# AND UserID = #username#
</delete>

<update id="UpdateProject" parameterClass="ProjectRecord">
	UPDATE proyecto
	SET 
		CompletionDate = #CompletionDate, typeHandler=DateTimeTypeHandler#,
		Description = #Description#,
		EstimateDuration = #EstimateDuration#,
		ManagerId =#ManagerUserName#,
		titulo = #Name#
	WHERE 
		ProjectID = #ID#
</update>

</sqlMap>
